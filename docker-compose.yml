services:
  # Development/Jenkins CI - builds from source
  web-dev:
    image: node:18
    container_name: toronto_web_dev
    profiles:
      - dev
      - jenkins
      - test
    ports:
      - "8083:3000"
    environment:
      - PORT=3000
    working_dir: /app
    command: sh -c "npm install && node server.js"
    volumes:
      - ./:/app
    networks:
      - toronto-network

  # Maven + Chrome test runner (Java Selenium tests)
  test-runner:
    image: markhobson/maven-chrome:latest
    container_name: toronto_test_runner
    profiles:
      - test
    depends_on:
      - web-dev
    working_dir: /app
    environment:
      - APP_URL=http://toronto_web_dev:3000
    volumes:
      - ./selenium-tests:/app
      - ./test-reports:/test-reports
    command: >
      bash -c "
        echo '===========================================' &&
        echo 'ðŸ§ª Starting Maven Selenium Tests...' &&
        echo '===========================================' &&
        echo 'Target URL: http://toronto_web_dev:3000' &&
        echo 'Waiting for app to be ready...' &&
        sleep 10 &&
        mvn clean test -Dapp.url=http://toronto_web_dev:3000 2>&1 | tee /test-reports/maven-output.log &&
        cp -r target/surefire-reports/* /test-reports/ 2>/dev/null || true &&
        echo '===========================================' &&
        echo 'âœ… Tests completed!' &&
        echo '==========================================='
      "
    networks:
      - toronto-network

  # Production - uses pre-built image from Docker Hub
  web-prod:
    image: maliknoor2004/toronto-webapp:latest
    container_name: toronto_web_prod
    profiles:
      - prod
      - pipeline
    ports:
      - "8082:3000"
    environment:
      - PORT=3000
    volumes:
      - ./firebase-service-account.json:/app/firebase-service-account.json
    networks:
      - toronto-network

networks:
  toronto-network:
    driver: bridge
